# Gas

## 为什么有 gas 这个东西

1. 防止 solidity 代码出现无限递归或者循环。这样会让代码一直在节点上运行。一直消耗计算机资源但是没有结果。
2. 以太坊强制用户对链上的操作付费，这样即使 solidity 中有无限循环，但是 gas 费是有限的， gas 费消耗完，代码就不继续执行了。也就变相的避免了无限循环。
3. 另一方面也是限制用户的恶意行为，对以太坊网络进行 ddos 攻击。



## gas 费怎么计算的

- gas price。表示的是  gas 费的单价。比如1gwei，3gwei。
- gas limit。gas 的上限。
- gas used。实际消耗的 gas。



## 每个操作，对 gas 的消耗

### 固定 gas



| 操作   | gas 消耗                | 说明         |
| ------ | ----------------------- | ------------ |
| ADD    | 3                       | 加法运算     |
| MUL    | 5                       | 乘法运算     |
| SLOAD  | 800 -> 200*             | 读存储       |
| SSTORE | 20,000 / 32字节         | 首次写入存储 |
| SSTORE | 5,000                   | 修改存储     |
| CALL   | 700                     | 调用外部合约 |
| SHA3   | 30 + 6/字节             | 计算哈希值   |
| LOG    | 375 + 375/主题 + 8/字节 | 触发事件日志 |

普通转账，固定 21,000 gas



### 动态 gas

内存扩展，每扩展 1 字节，消耗 3gs。

交易数据，非 0 字节消耗 16 gas/ 字节。0 字节消耗 4 gas/字节。

合约创建。按照合约的字节码，每字节消耗 200 gas。





## 优化 gas





### 存储优化



1. EVM 中用连续的 32 字节（256 位）来存储状态变量。变量的首次写入是 20,000 gas/ 32 字节。当声明顺序，能够满足 32 字节的整数倍，就能够利用好插槽，从而减少 gas 消耗。

   例如以下的变量声明，就是用了3个插槽。

   ```solidity
   uint128 a;
   uint256 b;
   uint128 c;
   ```

   改变变量声明的顺序，就只要使用2个插槽，从而节省了一次32字节的写入，节省了 20,000 gas

   ```solidity
   uint128 a;
   uint128 c;
   uint256 b;
   ```


2. 非必要，不要把数据写入到 solidity 的变量中，只在内存中使用。

    ```solidity
     function updateDate(uint256 newValue) external {
        uint256 temp = newValue + 1;  // 内存的操作,几乎无消耗. ADD运算消耗3
        storageValue = temp;   // 修改内存中数据,每次消耗 5000 gas
     }
    
     uint num = 0; 
     function expensiveLoop(uint x) public { 
        for(uint i = 0; i < x; i++) { 
            num += 1; // 使用临时变量来存储，不要频繁操作 storage 里的数据
        } 
     }
    ```

   



### 数据类型和操作优化

1. 尽可能使用常量和不可变的变量。固定长度数组和字符串比不固定长度消耗更多的 gas。

2. mapping 的消耗是固定的，每次只读取一个值。但是数组的消耗会随着长度线性递增。

3. 选择更合理的类型。EVM 以 32 字节为单位处理数据，使用 uint256 比 uint8 更省 gas，因为 uint8 需要转换成 uint256。

4. 使用位运算，替代乘除。

   ```solidity
   uint256 result = value * 8;
   
   // 左移3位，相当于 *8
   uint256 result = value << 3;
   ```

5. 不要初始化默认值，例如 `uint256 value;` 比 `uint256 value = 0;` 更便宜。

### 代码逻辑优化

1. 多使用 reqiure 在开头验证条件。
2. 多使用 pure 和 view 关键字来标记方法。让它是不可写的。
3. 经可能使用 event 来存储数据。成本更低。

### 框架优化

1. **不建议使用内联汇编来优化 gas**
2. 复杂运算移到链下，链上验证结果。
3. 分离逻辑合约和代理合约。减少重新部署的 gas。
4. 在发布合约之前，使用 hardhat 估算合约的 gas。在检查一遍
