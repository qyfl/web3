### 什么情况下应该使用 `uint` 或 `int`?

uint 不能存储负数，需要存储负数的时候用 int，其他都用 uint。



### 如何选择存储以太坊地址使用的数据结构？

adress 类型。钱包地址，合约地址，转账人地址，接收人地址。等等地址信息，全都用 adress 存储。



### 在何时使用 `string` 与 `bytes`?



文本长度不确定使用 string

不需要编码处理的字符使用 string



### 数组在 Solidity 中的应用场景是什么？

存储多个相同类型的值的时候使用数组。比如多签的情况下，存储签名者的列表。



### 为何以及如何使用 `mapping`?

存储一一对应的关系，比如账户和金额。交易和状态的对应关系。





### `struct` 的用途及实例?

适合复杂场景的记录，比如一笔交易。转给谁，金额是多少，data 数据，是否已经执行。





### 何时使用 `enum` 以及其好处是什么？

有限的常量，比如支付状态。发起支付，支付中。支付完成。或者订单的状态


### 在设计合约时如何考虑存储和 Gas 成本？



#### 存储优化

1. EVM 中用连续的 32 字节（256 位）来存储状态变量。变量的首次写入是 20,000 gas/ 32 字节。当声明顺序，能够满足 32 字节的整数倍，就能够利用好插槽，从而减少 gas 消耗。

   例如以下的变量声明，就是用了3个插槽。

   ```solidity
   uint128 a;
   uint256 b;
   uint128 c;
   ```

   改变变量声明的顺序，就只要使用2个插槽，从而节省了一次32字节的写入，节省了 20,000 gas

   ```solidity
   uint128 a;
   uint128 c;
   uint256 b;
   ```


2. 非必要，不要把数据写入到 solidity 的变量中，只在内存中使用。

    ```solidity
     function updateDate(uint256 newValue) external {
        uint256 temp = newValue + 1;  // 内存的操作,几乎无消耗. ADD运算消耗3
        storageValue = temp;   // 修改内存中数据,每次消耗 5000 gas
     }
    
     uint num = 0; 
     function expensiveLoop(uint x) public { 
        for(uint i = 0; i < x; i++) { 
            num += 1; // 使用临时变量来存储，不要频繁操作 storage 里的数据
        } 
     }
    ```

   



#### 数据类型和操作优化

1. 尽可能使用常量和不可变的变量。固定长度数组和字符串比不固定长度消耗更多的 gas。

2. mapping 的消耗是固定的，每次只读取一个值。但是数组的消耗会随着长度线性递增。

3. 选择更合理的类型。EVM 以 32 字节为单位处理数据，使用 uint256 比 uint8 更省 gas，因为 uint8 需要转换成 uint256。

4. 使用位运算，替代乘除。

   ```solidity
   uint256 result = value * 8;
   
   // 左移3位，相当于 *8
   uint256 result = value << 3;
   ```

5. 不要初始化默认值，例如 `uint256 value;` 比 `uint256 value = 0;` 更便宜。



#### 代码逻辑优化

1. 多使用 reqiure 在开头验证条件。
2. 多使用 pure 和 view 关键字来标记方法。让它是不可写的。
3. 经可能使用 event 来存储数据。成本更低。



#### 框架优化

1. **不建议使用内联汇编来优化 gas**
2. 复杂运算移到链下，链上验证结果。
3. 分离逻辑合约和代理合约。减少重新部署的 gas。
4. 在发布合约之前，使用 hardhat 估算合约的 gas。在检查一遍



### 如何根据数据访问模式选择数据结构？

根据业务场景和操作方便程度来选择数据结构,顺序访问更适合使用数字,随机访问更适合 mapping





### 在复杂合约中选择数据结构的考虑因素有哪些？

1. 尽可能少的使用数据结构,用来节省 gas.能使用1个结构完成的操作,不要使用多个结构来存储.
2. 完成业务功能





### 如何决定使用固定长度的数组还是动态数组？



看数组内容是不是固定的.在编码的时候就知道数据的长度,就使用固定长度的.不知道就是用动态数组.



### 在 Solidity 中使用 `mapping` 和 `array` 的主要区别及使用场景是什么？

mapping 存储的是一对一的数据,能快速定位

array 能顺序访问全部数据.



### 如何利用 `struct` 在 Solidity 中模拟传统的数据库表？

把表的字段,按照类型一一在 struct 中对应出来.无法对应的类型都是用 string 来存储.



在使用 mapping 来存储主键ID 和 struct 的对应关系



### Solidity 中 `enum` 如何帮助降低错误的发生？

enum 的数量是有限的。反复多次使用的字符串，可以减少拼写的错误。而且维护性更高。





### 为何 `bytes` 类型有时比 `string` 更优？

bytes 比 string 更省 gas，所以当有不需要处理的字符，使用 bytes。





### 如何选择在 Solidity 中存储时间的最佳数据结构？

uint256 存储时间戳，它和 EVM 里的事件函数兼容。



### 在 Solidity 合约中，何时应考虑将数据封装在 `struct` 内部？

逻辑上是一个东西的时候，可以考虑把多个变量封装成一个 struct。





### `mapping` 类型是否支持迭代？如果不支持，如何解决？

不支持迭代，非要迭代，需要另外在维护一个数组，存储 mapping 的 key。通过遍历数组，来遍历 mapping



### 在设计一个包含多种资产类型的钱包合约时，应使用哪种数据结构？

看是否需要快速的知道余额，如果需要，使用 mapping 中嵌套 mapping 的做法。

不需要可以使用 mapping +  struct 





### 使用 `enum` 定义状态时，应如何处理状态的转换逻辑？

按照正确的业务流程，来存储和验证状态的流转。

