

# uniswap 原理

## uniswap V1

v1 实现的内容非常简单，就是实现了 ERC20 代币和 ETH 之间的互换。如果用 1BNB 换对应数量的 USDT。在这中间， ETH 是中介，BNB 先兑换成 ETH，ETH 换成 USDT。



这要注意一点，v1 只支持代币的互换，如果想要用 USDT 换 ETH，是不行的。你只能换 WETH，也就是 ETH 的 ERC20 版本。WETH 和 ETH 1:1 锚定。

## uniswap V2

先假设一种场景，有这么一个DEX（去中心化交易所）里只有 2 种币，ETH 和 BNB。假设现在的价格是  1ETH = 100 BNB。

###  LP

一个正常的情况。一个人用 ETH 来换 BNB，如果这个交易所，BNB 的储备量很低，只有 1,000 个。那么有人出 10个 ETH，就能买光这个交易所的 BNB 储备。这个交易所就干不下去了。所以交易所就需要有人来提供流动性，要么是交易所自己买很多的 ETH 和 BNB 给客户用来交易，要么是找 LP（Liquidity Provider）来提供流动性，也就是借币放到交易所里。这需要给 LP 一些好处。通常情况是交易所对每笔交易抽一定比例的手续费，通常是 0.3%，这个手续费可以和 LP 来分，也可以全部给 LP。

### 恒定乘积自动做市商

如果你想做 LP，挣手续费。手里有很多的 BNB，但是只有 1 个 ETH 甚至没有 ETH可以吗？不行。交易所的池子里， ETH 很少，BNB 很多。如果很多人用 BNB 换 ETH，就很容易把 ETH 换完。所以做 LP 提供流动性，是需要存入代币对，也就是 2 种代币都要提供。

uniswap 所采用的模式是**恒定乘积自动做市商**。提供代币对提供流动性这个动作叫做做市。x * y = k。 x 和 y 表示的代币的数量，k 就是流动性。在 uniswap 中，**k 的值是不变的**。他们之间的关系呈现这样一种曲线。这个k 不变，不是指 k 永远不变。LP 的作用就是让 k 变得很大，k 不变指的是交易的时候 k 不变。用 x 换 y 的时候，k 不变。注入流动性的时候，也就是往池子里增加 x 和 y 的时候。k 是会变大的。

<img src="E:\code\web3\assets\image-20250325214155263.png" alt="image-20250325214155263" style="zoom: 50%;" />



假设 x 表示 ETH，有10个。y 表示 BNB 有40,000 个。 x*y = k = 400,000。 

ETH 价格 = BNB数量/ETH数量 = 4000BNB/ETH。BNB 价格 = ETH数量/BNB数量 = 0.00025ETH/BNB。



假如用户用1000个 BNB 换 ETH。

1. 池子里就会多 1000 BNB，变成 41,000 个 BNB。
2. k 不变， ETH 数量 = k / BNB 的数量 = 400,000 / 41,000 = 9.7560976。
3. 池子里现在有 10个  ETH ，需要给用户的就是 10 - 9.7560976 = 0.2439024。
4. **注意！**在没有换之前， 1000 个BNB 能换 0.25个 ETH。但是只要交换，就会发生**滑点**价格会下降。
5. 池子越深，也就是流动性越大。相同金额的交易，产生的滑点越低。



**滑点：**在没有交易的时候 BNB 的价格是 0.00025ETH/BNB，真正交易结束拿到的不到这么多，中间的差值，就是滑点。也就是上图中的曲线上，从一处滑动到另一处。



常数K = (TokenA余额 + 你出售的TokenA)*(TokenB余额 - 你获得的TokenB) 

### 无常损失

通俗的来理解，做 LP，无论市场是涨或者跌，你都会产生更多的损失。涨的话，没有市场涨得多，跌的话，比市场跌的狠。



假设做 LP，用 10个 ETH 和 40,000 个 BNB 提供流动性。此时 k = 400,000。

ETH 价格 = 4000BNB/ETH。BNB 价格 = 0.00025ETH/BNB。

**初始价值：** 10*40,000 BNB + 40,000 BNB = 80,000 BNB



#### ETH 涨价

假设 ETH:BNB  从 10:40,000  变成了 8:50,000，k 不变还是 400,000。

k = x*y = 8\*50,000 = 400,000

ETH 价格 = 50,000/8 = 6250 BNB/ETH

现值  = 8*6250BNB + 50,000 BNB = 100,000BNB

盈利 = 现值 - 初始价值  100,000 BNB - 80,000 BNB = 20,000 BNB



**不做LP：**

现值 = 10 ETH * 6250 BNB/ETH  + 40,000 BNB =  102,500 BNB

盈利 = 现值 - 初始价值 = 102,500 - 80,000 = 22,500 BNB

不做 LP 的盈利是 > 做 LP 的盈利的。这就是**涨的话，没有市场涨得多。**



#### ETH 贬值

假设 ETH:BNB  从 10:40,000  变成了 16:25,000，k 不变还是 400,000。

k = x*y = 16\*25,000 = 400,000

ETH 价格 = 25,000/16 = 1562.5 BNB/ETH

现值 = 16*1562.5 + 25,000 = 50,000 BNB

盈利 = 现值 - 初始价值 = 50,000 - 80,000 = -30,000BNB



**不做LP：**

现值 = 10 ETH * 1562.5 BNB/ETH  + 40,000 BNB =  55625 BNB

盈利 = 现值 - 初始价值 = 55625 - 80,000 = 24,375 BNB

不做 LP 的亏损是 < 做 LP 的亏损的。这就是**跌的话，比市场跌的狠。**



这就是在恒定乘积自动做市商这个模型下，做 LP 一定会产生更多的损失。称为无常损失。那为什么要做 LP 呢？在 uniswap v2 中，就是堵市场不会剧烈波动，堵手续费 > 无常损失。



### 快速借贷/闪电借贷





### 价格预言机（Oracle）

预言机不是用来预测价格的。而是区块链和其他系统的通信。





## uniswap V3







## uniswap V4







